#!/usr/bin/env python3
"""YouTube Data API v3 CLI with OAuth support"""

import argparse
import json
import os
import sys
import webbrowser
import http.server
import urllib.parse
from pathlib import Path
from urllib.request import urlopen, Request
from urllib.parse import urlencode, quote_plus
from urllib.error import HTTPError

API_BASE = "https://www.googleapis.com/youtube/v3"
OAUTH_AUTH_URL = "https://accounts.google.com/o/oauth2/v2/auth"
OAUTH_TOKEN_URL = "https://oauth2.googleapis.com/token"
TOKEN_FILE = Path.home() / ".config" / "yt-cli" / "token.json"
CREDENTIALS_FILE = Path.home() / ".config" / "yt-cli" / "credentials.json"

SCOPES = [
    "https://www.googleapis.com/auth/youtube.readonly",
    "https://www.googleapis.com/auth/youtube.force-ssl"
]

def get_api_key():
    key = os.environ.get("YOUTUBE_API_KEY")
    if not key:
        print("Error: YOUTUBE_API_KEY environment variable not set", file=sys.stderr)
        sys.exit(1)
    return key

def load_credentials():
    """Load OAuth credentials from file"""
    if not CREDENTIALS_FILE.exists():
        return None
    with open(CREDENTIALS_FILE) as f:
        return json.load(f)

def load_token():
    """Load saved OAuth token"""
    if not TOKEN_FILE.exists():
        return None
    with open(TOKEN_FILE) as f:
        return json.load(f)

def save_token(token):
    """Save OAuth token to file"""
    TOKEN_FILE.parent.mkdir(parents=True, exist_ok=True)
    with open(TOKEN_FILE, "w") as f:
        json.dump(token, f)

def refresh_token(token, credentials):
    """Refresh expired access token"""
    data = urlencode({
        "client_id": credentials["client_id"],
        "client_secret": credentials["client_secret"],
        "refresh_token": token["refresh_token"],
        "grant_type": "refresh_token"
    }).encode()
    
    req = Request(OAUTH_TOKEN_URL, data=data, method="POST")
    with urlopen(req) as resp:
        new_token = json.loads(resp.read().decode())
        token["access_token"] = new_token["access_token"]
        if "refresh_token" in new_token:
            token["refresh_token"] = new_token["refresh_token"]
        save_token(token)
        return token

def get_oauth_token():
    """Get valid OAuth token, refreshing if needed"""
    token = load_token()
    credentials = load_credentials()
    
    if not token or not credentials:
        return None
    
    # Try to use token, refresh if expired
    return token

def api_request(endpoint, params, use_oauth=False):
    """Make API request with API key or OAuth"""
    token = get_oauth_token() if use_oauth else None
    
    if use_oauth and not token:
        print("Error: OAuth not configured. Run 'yt auth' first.", file=sys.stderr)
        sys.exit(1)
    
    if not use_oauth:
        params["key"] = get_api_key()
    
    url = f"{API_BASE}/{endpoint}?{urlencode(params)}"
    headers = {"Accept": "application/json"}
    
    if token:
        headers["Authorization"] = f"Bearer {token['access_token']}"
    
    try:
        req = Request(url, headers=headers)
        with urlopen(req) as resp:
            return json.loads(resp.read().decode())
    except HTTPError as e:
        if e.code == 401 and token:
            # Try refreshing token
            credentials = load_credentials()
            if credentials:
                try:
                    token = refresh_token(token, credentials)
                    headers["Authorization"] = f"Bearer {token['access_token']}"
                    req = Request(url, headers=headers)
                    with urlopen(req) as resp:
                        return json.loads(resp.read().decode())
                except:
                    pass
        error_body = e.read().decode()
        print(f"API Error ({e.code}): {error_body}", file=sys.stderr)
        sys.exit(1)

def format_duration(iso_duration):
    """Convert ISO 8601 duration to human readable"""
    import re
    match = re.match(r'PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?', iso_duration)
    if not match:
        return iso_duration
    h, m, s = match.groups()
    parts = []
    if h: parts.append(f"{h}h")
    if m: parts.append(f"{m}m")
    if s: parts.append(f"{s}s")
    return " ".join(parts) if parts else "0s"

def format_number(n):
    """Format large numbers with K/M/B suffixes"""
    n = int(n)
    if n >= 1_000_000_000:
        return f"{n/1_000_000_000:.1f}B"
    if n >= 1_000_000:
        return f"{n/1_000_000:.1f}M"
    if n >= 1_000:
        return f"{n/1_000:.1f}K"
    return str(n)

def cmd_auth(args):
    """Setup OAuth authentication"""
    print("YouTube OAuth Setup\n")
    
    # Check for existing credentials
    credentials = load_credentials()
    
    if not credentials:
        print("1. Go to Google Cloud Console: https://console.cloud.google.com/apis/credentials")
        print("2. Create OAuth 2.0 Client ID (Desktop app)")
        print("3. Download JSON and save as:")
        print(f"   {CREDENTIALS_FILE}\n")
        print("Or paste your client_id and client_secret below:\n")
        
        client_id = input("Client ID: ").strip()
        client_secret = input("Client Secret: ").strip()
        
        if not client_id or not client_secret:
            print("Error: Both client_id and client_secret required")
            sys.exit(1)
        
        credentials = {
            "client_id": client_id,
            "client_secret": client_secret
        }
        CREDENTIALS_FILE.parent.mkdir(parents=True, exist_ok=True)
        with open(CREDENTIALS_FILE, "w") as f:
            json.dump(credentials, f)
        print(f"\n‚úì Credentials saved to {CREDENTIALS_FILE}")
    
    # Start OAuth flow
    redirect_uri = "http://localhost:8765"
    auth_params = {
        "client_id": credentials["client_id"],
        "redirect_uri": redirect_uri,
        "response_type": "code",
        "scope": " ".join(SCOPES),
        "access_type": "offline",
        "prompt": "consent"
    }
    
    auth_url = f"{OAUTH_AUTH_URL}?{urlencode(auth_params)}"
    print(f"\nOpening browser for authentication...")
    print(f"If browser doesn't open, visit:\n{auth_url}\n")
    webbrowser.open(auth_url)
    
    # Simple HTTP server to catch the callback
    auth_code = None
    
    class CallbackHandler(http.server.BaseHTTPRequestHandler):
        def do_GET(self):
            nonlocal auth_code
            query = urllib.parse.urlparse(self.path).query
            params = urllib.parse.parse_qs(query)
            
            if "code" in params:
                auth_code = params["code"][0]
                self.send_response(200)
                self.send_header("Content-type", "text/html")
                self.end_headers()
                self.wfile.write(b"<html><body><h1>Success!</h1><p>You can close this window.</p></body></html>")
            else:
                self.send_response(400)
                self.send_header("Content-type", "text/html")
                self.end_headers()
                self.wfile.write(b"<html><body><h1>Error</h1><p>No authorization code received.</p></body></html>")
        
        def log_message(self, format, *args):
            pass  # Suppress logging
    
    server = http.server.HTTPServer(("localhost", 8765), CallbackHandler)
    print("Waiting for authentication...")
    server.handle_request()
    
    if not auth_code:
        print("Error: No authorization code received")
        sys.exit(1)
    
    # Exchange code for token
    token_data = urlencode({
        "client_id": credentials["client_id"],
        "client_secret": credentials["client_secret"],
        "code": auth_code,
        "grant_type": "authorization_code",
        "redirect_uri": redirect_uri
    }).encode()
    
    req = Request(OAUTH_TOKEN_URL, data=token_data, method="POST")
    try:
        with urlopen(req) as resp:
            token = json.loads(resp.read().decode())
            save_token(token)
            print("\n‚úì Authentication successful!")
            print("You can now use commands that require OAuth (liked, subscriptions, etc.)")
    except HTTPError as e:
        print(f"Error exchanging code for token: {e.read().decode()}")
        sys.exit(1)

def cmd_search(args):
    params = {
        "part": "snippet",
        "q": args.query,
        "maxResults": args.max,
        "type": args.type,
    }
    if args.region:
        params["regionCode"] = args.region
    
    data = api_request("search", params)
    
    if args.json:
        print(json.dumps(data, indent=2, ensure_ascii=False))
        return
    
    for item in data.get("items", []):
        snippet = item["snippet"]
        kind = item["id"]["kind"].split("#")[1]
        
        if kind == "video":
            vid = item["id"]["videoId"]
            print(f"üé¨ {snippet['title']}")
            print(f"   Channel: {snippet['channelTitle']}")
            print(f"   URL: https://youtube.com/watch?v={vid}")
        elif kind == "channel":
            cid = item["id"]["channelId"]
            print(f"üì∫ {snippet['title']}")
            print(f"   {snippet.get('description', '')[:100]}")
            print(f"   URL: https://youtube.com/channel/{cid}")
        elif kind == "playlist":
            pid = item["id"]["playlistId"]
            print(f"üìã {snippet['title']}")
            print(f"   Channel: {snippet['channelTitle']}")
            print(f"   URL: https://youtube.com/playlist?list={pid}")
        print()

def cmd_video(args):
    parts = ["snippet", "contentDetails"]
    if args.stats:
        parts.append("statistics")
    
    params = {
        "part": ",".join(parts),
        "id": args.video_id,
    }
    
    data = api_request("videos", params)
    
    if args.json:
        print(json.dumps(data, indent=2, ensure_ascii=False))
        return
    
    if not data.get("items"):
        print("Video not found", file=sys.stderr)
        sys.exit(1)
    
    item = data["items"][0]
    snippet = item["snippet"]
    details = item["contentDetails"]
    
    print(f"üé¨ {snippet['title']}")
    print(f"Channel: {snippet['channelTitle']}")
    print(f"Published: {snippet['publishedAt'][:10]}")
    print(f"Duration: {format_duration(details['duration'])}")
    print(f"URL: https://youtube.com/watch?v={args.video_id}")
    
    if args.stats and "statistics" in item:
        stats = item["statistics"]
        print(f"\nüìä Stats:")
        print(f"   Views: {format_number(stats.get('viewCount', 0))}")
        print(f"   Likes: {format_number(stats.get('likeCount', 0))}")
        print(f"   Comments: {format_number(stats.get('commentCount', 0))}")
    
    print(f"\nüìù Description:\n{snippet.get('description', '')[:500]}")
    
    if args.comments:
        print("\nüí¨ Top Comments:")
        cmd_comments_internal(args.video_id, 5, False, False)

def cmd_comments_internal(video_id, max_results, include_replies, as_json):
    params = {
        "part": "snippet",
        "videoId": video_id,
        "maxResults": max_results,
        "order": "relevance",
    }
    
    data = api_request("commentThreads", params)
    
    if as_json:
        print(json.dumps(data, indent=2, ensure_ascii=False))
        return
    
    for item in data.get("items", []):
        comment = item["snippet"]["topLevelComment"]["snippet"]
        print(f"  @{comment['authorDisplayName']}: {comment['textDisplay'][:200]}")
        if include_replies and item["snippet"]["totalReplyCount"] > 0:
            print(f"    ‚îî {item['snippet']['totalReplyCount']} replies")

def cmd_comments(args):
    if args.json:
        params = {
            "part": "snippet,replies" if args.replies else "snippet",
            "videoId": args.video_id,
            "maxResults": args.max,
            "order": "relevance",
        }
        data = api_request("commentThreads", params)
        print(json.dumps(data, indent=2, ensure_ascii=False))
        return
    
    print(f"üí¨ Comments for video {args.video_id}:\n")
    cmd_comments_internal(args.video_id, args.max, args.replies, False)

def cmd_channel(args):
    # Handle @handle format
    channel_id = args.channel_id
    if channel_id.startswith("@"):
        # Search for channel by handle
        search_params = {
            "part": "snippet",
            "q": channel_id,
            "type": "channel",
            "maxResults": 1,
        }
        search_data = api_request("search", search_params)
        if not search_data.get("items"):
            print(f"Channel {channel_id} not found", file=sys.stderr)
            sys.exit(1)
        channel_id = search_data["items"][0]["id"]["channelId"]
    
    parts = ["snippet", "statistics", "contentDetails"]
    params = {
        "part": ",".join(parts),
        "id": channel_id,
    }
    
    data = api_request("channels", params)
    
    if args.json and not args.videos and not args.playlists:
        print(json.dumps(data, indent=2, ensure_ascii=False))
        return
    
    if not data.get("items"):
        print("Channel not found", file=sys.stderr)
        sys.exit(1)
    
    item = data["items"][0]
    snippet = item["snippet"]
    stats = item["statistics"]
    
    print(f"üì∫ {snippet['title']}")
    if snippet.get("customUrl"):
        print(f"Handle: {snippet['customUrl']}")
    print(f"Subscribers: {format_number(stats.get('subscriberCount', 0))}")
    print(f"Total Views: {format_number(stats.get('viewCount', 0))}")
    print(f"Videos: {stats.get('videoCount', 0)}")
    print(f"URL: https://youtube.com/channel/{channel_id}")
    print(f"\n{snippet.get('description', '')[:300]}")
    
    if args.videos:
        uploads_id = item["contentDetails"]["relatedPlaylists"]["uploads"]
        print(f"\nüé¨ Recent Videos:")
        playlist_params = {
            "part": "snippet",
            "playlistId": uploads_id,
            "maxResults": args.max if hasattr(args, 'max') else 10,
        }
        playlist_data = api_request("playlistItems", playlist_params)
        for pitem in playlist_data.get("items", []):
            psnippet = pitem["snippet"]
            vid = psnippet["resourceId"]["videoId"]
            print(f"  ‚Ä¢ {psnippet['title']}")
            print(f"    https://youtube.com/watch?v={vid}")
    
    if args.playlists:
        print(f"\nüìã Playlists:")
        pl_params = {
            "part": "snippet",
            "channelId": channel_id,
            "maxResults": 10,
        }
        pl_data = api_request("playlists", pl_params)
        for pitem in pl_data.get("items", []):
            print(f"  ‚Ä¢ {pitem['snippet']['title']}")
            print(f"    https://youtube.com/playlist?list={pitem['id']}")

def cmd_playlist(args):
    params = {
        "part": "snippet",
        "playlistId": args.playlist_id,
        "maxResults": args.max,
    }
    
    data = api_request("playlistItems", params)
    
    if args.json:
        print(json.dumps(data, indent=2, ensure_ascii=False))
        return
    
    print(f"üìã Playlist items:\n")
    for i, item in enumerate(data.get("items", []), 1):
        snippet = item["snippet"]
        vid = snippet["resourceId"]["videoId"]
        print(f"{i}. {snippet['title']}")
        print(f"   https://youtube.com/watch?v={vid}")

def cmd_trending(args):
    params = {
        "part": "snippet,statistics",
        "chart": "mostPopular",
        "maxResults": args.max if hasattr(args, 'max') else 10,
    }
    if args.region:
        params["regionCode"] = args.region
    if args.category:
        category_map = {
            "music": "10",
            "gaming": "20",
            "news": "25",
            "movies": "30",
            "sports": "17",
            "tech": "28",
        }
        if args.category in category_map:
            params["videoCategoryId"] = category_map[args.category]
    
    data = api_request("videos", params)
    
    if args.json:
        print(json.dumps(data, indent=2, ensure_ascii=False))
        return
    
    region = args.region or "US"
    print(f"üî• Trending in {region}:\n")
    for i, item in enumerate(data.get("items", []), 1):
        snippet = item["snippet"]
        stats = item.get("statistics", {})
        print(f"{i}. {snippet['title']}")
        print(f"   Channel: {snippet['channelTitle']}")
        print(f"   Views: {format_number(stats.get('viewCount', 0))}")
        print(f"   https://youtube.com/watch?v={item['id']}")
        print()

def cmd_liked(args):
    """Get user's liked videos (requires OAuth)"""
    params = {
        "part": "snippet",
        "myRating": "like",
        "maxResults": args.max,
    }
    
    data = api_request("videos", params, use_oauth=True)
    
    if args.json:
        print(json.dumps(data, indent=2, ensure_ascii=False))
        return
    
    print("‚ù§Ô∏è Liked Videos:\n")
    for i, item in enumerate(data.get("items", []), 1):
        snippet = item["snippet"]
        print(f"{i}. {snippet['title']}")
        print(f"   Channel: {snippet['channelTitle']}")
        print(f"   https://youtube.com/watch?v={item['id']}")
        print()

def cmd_subscriptions(args):
    """Get user's subscriptions (requires OAuth)"""
    params = {
        "part": "snippet",
        "mine": "true",
        "maxResults": args.max,
        "order": "alphabetical" if args.alpha else "relevance",
    }
    
    data = api_request("subscriptions", params, use_oauth=True)
    
    if args.json:
        print(json.dumps(data, indent=2, ensure_ascii=False))
        return
    
    print("üì∫ Subscriptions:\n")
    for i, item in enumerate(data.get("items", []), 1):
        snippet = item["snippet"]
        channel_id = snippet["resourceId"]["channelId"]
        print(f"{i}. {snippet['title']}")
        print(f"   {snippet.get('description', '')[:80]}")
        print(f"   https://youtube.com/channel/{channel_id}")
        print()

def cmd_playlists_mine(args):
    """Get user's playlists (requires OAuth)"""
    params = {
        "part": "snippet,contentDetails",
        "mine": "true",
        "maxResults": args.max,
    }
    
    data = api_request("playlists", params, use_oauth=True)
    
    if args.json:
        print(json.dumps(data, indent=2, ensure_ascii=False))
        return
    
    print("üìã My Playlists:\n")
    for i, item in enumerate(data.get("items", []), 1):
        snippet = item["snippet"]
        details = item["contentDetails"]
        print(f"{i}. {snippet['title']} ({details['itemCount']} videos)")
        print(f"   https://youtube.com/playlist?list={item['id']}")
        print()

def cmd_history(args):
    """Note: Watch history is not available via API"""
    print("‚ö†Ô∏è Watch history is not accessible via YouTube API")
    print("YouTube removed this feature from the API for privacy reasons.")
    print("\nAlternatives:")
    print("- Use Google Takeout to export your watch history")
    print("- Check youtube.com/feed/history in browser")

def main():
    parser = argparse.ArgumentParser(description="YouTube Data API v3 CLI")
    subparsers = parser.add_subparsers(dest="command", required=True)
    
    # Auth
    auth_p = subparsers.add_parser("auth", help="Setup OAuth authentication")
    auth_p.set_defaults(func=cmd_auth)
    
    # Search
    search_p = subparsers.add_parser("search", help="Search YouTube")
    search_p.add_argument("query", help="Search query")
    search_p.add_argument("--max", type=int, default=10, help="Max results")
    search_p.add_argument("--type", default="video", choices=["video", "channel", "playlist"])
    search_p.add_argument("--region", help="Region code (e.g., KR, US)")
    search_p.add_argument("--json", action="store_true", help="JSON output")
    search_p.set_defaults(func=cmd_search)
    
    # Video
    video_p = subparsers.add_parser("video", help="Get video details")
    video_p.add_argument("video_id", help="Video ID")
    video_p.add_argument("--stats", action="store_true", help="Include statistics")
    video_p.add_argument("--comments", action="store_true", help="Include top comments")
    video_p.add_argument("--json", action="store_true", help="JSON output")
    video_p.set_defaults(func=cmd_video)
    
    # Comments
    comments_p = subparsers.add_parser("comments", help="Get video comments")
    comments_p.add_argument("video_id", help="Video ID")
    comments_p.add_argument("--max", type=int, default=20, help="Max results")
    comments_p.add_argument("--replies", action="store_true", help="Include replies")
    comments_p.add_argument("--json", action="store_true", help="JSON output")
    comments_p.set_defaults(func=cmd_comments)
    
    # Channel
    channel_p = subparsers.add_parser("channel", help="Get channel info")
    channel_p.add_argument("channel_id", help="Channel ID or @handle")
    channel_p.add_argument("--videos", action="store_true", help="List recent videos")
    channel_p.add_argument("--playlists", action="store_true", help="List playlists")
    channel_p.add_argument("--max", type=int, default=10, help="Max videos/playlists")
    channel_p.add_argument("--json", action="store_true", help="JSON output")
    channel_p.set_defaults(func=cmd_channel)
    
    # Playlist
    playlist_p = subparsers.add_parser("playlist", help="List playlist items")
    playlist_p.add_argument("playlist_id", help="Playlist ID")
    playlist_p.add_argument("--max", type=int, default=50, help="Max results")
    playlist_p.add_argument("--json", action="store_true", help="JSON output")
    playlist_p.set_defaults(func=cmd_playlist)
    
    # Trending
    trending_p = subparsers.add_parser("trending", help="Get trending videos")
    trending_p.add_argument("--region", default="US", help="Region code")
    trending_p.add_argument("--category", choices=["music", "gaming", "news", "movies", "sports", "tech"])
    trending_p.add_argument("--max", type=int, default=10, help="Max results")
    trending_p.add_argument("--json", action="store_true", help="JSON output")
    trending_p.set_defaults(func=cmd_trending)
    
    # === OAuth-required commands ===
    
    # Liked videos
    liked_p = subparsers.add_parser("liked", help="Get liked videos (OAuth)")
    liked_p.add_argument("--max", type=int, default=25, help="Max results")
    liked_p.add_argument("--json", action="store_true", help="JSON output")
    liked_p.set_defaults(func=cmd_liked)
    
    # Subscriptions
    subs_p = subparsers.add_parser("subscriptions", help="Get subscriptions (OAuth)")
    subs_p.add_argument("--max", type=int, default=25, help="Max results")
    subs_p.add_argument("--alpha", action="store_true", help="Sort alphabetically")
    subs_p.add_argument("--json", action="store_true", help="JSON output")
    subs_p.set_defaults(func=cmd_subscriptions)
    
    # My playlists
    mypl_p = subparsers.add_parser("my-playlists", help="Get my playlists (OAuth)")
    mypl_p.add_argument("--max", type=int, default=25, help="Max results")
    mypl_p.add_argument("--json", action="store_true", help="JSON output")
    mypl_p.set_defaults(func=cmd_playlists_mine)
    
    # History (not available)
    history_p = subparsers.add_parser("history", help="Watch history (not available via API)")
    history_p.set_defaults(func=cmd_history)
    
    args = parser.parse_args()
    args.func(args)

if __name__ == "__main__":
    main()
